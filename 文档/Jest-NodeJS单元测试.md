# Jestæµ‹è¯•å·¥å…·è°ƒç ”

## åŸºç¡€çŸ¥è¯†

### Jest æ˜¯ä»€ä¹ˆï¼Ÿ

Jest æ˜¯ç”± **Metaï¼ˆFacebookï¼‰** å¼€å‘çš„å¼€æº JavaScript æµ‹è¯•æ¡†æ¶ï¼Œæä¾› **é›¶é…ç½®**ã€**å¼€ç®±å³ç”¨** çš„æµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚æ ¸å¿ƒä¼˜åŠ¿ï¼š
- ğŸš€ æç®€é…ç½®
- âš¡ï¸ å¹¶è¡Œæµ‹è¯•æ‰§è¡Œ
- ğŸ§ª å¼ºå¤§çš„ Mocking åŠŸèƒ½
- ğŸ“¸ åˆ›æ–°çš„å¿«ç…§æµ‹è¯•

#### é€‚ç”¨åœºæ™¯

React/Vue/Angular ç»„ä»¶æµ‹è¯•ã€Node.js API æµ‹è¯•ã€JavaScript åº“æµ‹è¯•

### æ ¸å¿ƒç‰¹æ€§

1. **å¼€ç®±å³ç”¨ï¼Œé›¶é…ç½®**

   - å®‰è£…ååŸºæœ¬æ— éœ€é¢å¤–é…ç½®ã€‚
   - å†…ç½®æµ‹è¯•è¿è¡Œå™¨ã€æ–­è¨€åº“ã€Mock åº“ã€è¦†ç›–ç‡å·¥å…·ã€DOM æ“ä½œç¯å¢ƒï¼ˆ`jsdom`ï¼‰ã€‚
   - è‡ªåŠ¨å‘ç°æµ‹è¯•æ–‡ä»¶ï¼ˆé»˜è®¤æŸ¥æ‰¾ `__tests__` ç›®å½•æˆ– `.test.js`/`.spec.js` æ–‡ä»¶ï¼‰ã€‚

2. **å¼ºå¤§çš„æ–­è¨€åº“**

      æä¾›ä¸°å¯Œã€å¯è¯»æ€§é«˜çš„æ–­è¨€å‡½æ•°ï¼ˆ`expect`, `toBe`, `toEqual`, `toMatch`, `toThrow` ç­‰ï¼‰ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ã€‚

3. **å‡ºè‰²çš„ Mocking åŠŸèƒ½**
   - æ¨¡æ‹Ÿå‡½æ•°ã€æ¨¡å—ã€å®šæ—¶å™¨ã€ç¬¬ä¸‰æ–¹åº“æˆ– API è°ƒç”¨ã€‚
   - ä½¿ç”¨ `jest.fn()`, `jest.mock()`, `jest.spyOn()` ç­‰ APIã€‚
   - ç”¨äºéš”ç¦»ä¾èµ–ã€éªŒè¯å‡½æ•°è°ƒç”¨ã€æ§åˆ¶ä¾èµ–è¡Œä¸ºã€‚

4. **å¿«ç…§æµ‹è¯•**
   - é€‚ç”¨äºæµ‹è¯• UI ç»„ä»¶è¾“å‡ºã€é…ç½®æ–‡ä»¶ã€æ•°æ®ç»“æ„ç­‰ã€‚
   - é¦–æ¬¡è¿è¡Œä¿å­˜å¿«ç…§ï¼Œåç»­æ¯”è¾ƒå·®å¼‚ã€‚
   - å¯æ›´æ–°å¿«ç…§ï¼ˆ`jest -u`ï¼‰ã€‚

5. **æµ‹è¯•è¦†ç›–ç‡**
   - å†…ç½®é›†æˆ `Istanbul` å·¥å…·ã€‚
   - é€šè¿‡ `--coverage` æ ‡å¿—ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šã€‚
   - æ˜¾ç¤ºä»£ç è¡Œã€åˆ†æ”¯ã€å‡½æ•°ã€è¯­å¥çš„è¦†ç›–æƒ…å†µã€‚

### Jest Mocking

Jest çš„ Mocking åŠŸèƒ½æ˜¯å…¶æœ€å¼ºå¤§çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå…è®¸ä½ åˆ›å»ºæ¨¡æ‹Ÿå¯¹è±¡ï¼ˆmocksï¼‰æ¥æ›¿ä»£çœŸå®ä¾èµ–ï¼Œä»è€Œå®ç°æµ‹è¯•çš„éš”ç¦»æ€§ã€å¯æ§æ€§å’Œé«˜æ•ˆæ€§ï¼š

 - åˆ‡æ–­è¢«æµ‹ä»£ç ä¸å¤–éƒ¨ä¾èµ–çš„è”ç³»ï¼›
 - æ¨¡æ‹Ÿå„ç§åœºæ™¯ï¼ˆæˆåŠŸã€å¤±è´¥ã€è¶…æ—¶ç­‰ï¼‰ï¼›
 - é¿å…çœŸå®ç½‘ç»œè¯·æ±‚æˆ–å¤æ‚è®¡ç®—ï¼›
 - æ£€æŸ¥è¢«æµ‹ä»£ç æ˜¯å¦æ­£ç¡®è°ƒç”¨ä¾èµ–ï¼›

#### æ ¸å¿ƒ API

**jest.fn(implementation?)** - åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå‡½æ•° (Mock Function)

è¿™æ˜¯æœ€åŸºç¡€çš„ Mock å·¥å…·ã€‚å®ƒåˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç©ºçš„ã€ä»€ä¹ˆéƒ½ä¸åšçš„å‡½æ•°ï¼Œä½†è¿™ä¸ªå‡½æ•°ä¼šè®°ä½å®ƒä½•æ—¶è¢«è°ƒç”¨ã€è¢«è°è°ƒç”¨ã€è°ƒç”¨æ—¶ä¼ é€’äº†ä»€ä¹ˆå‚æ•°ï¼š

```angular2html
   // åˆ›å»ºä¸€ä¸ªä»€ä¹ˆéƒ½ä¸åšçš„æ¨¡æ‹Ÿå‡½æ•°
   const mockCallback = jest.fn();
   
   // åˆ›å»ºä¸€ä¸ªè¿”å›å›ºå®šå€¼ 42 çš„æ¨¡æ‹Ÿå‡½æ•°
   const mockReturn = jest.fn().mockReturnValue(42);
   console.log(mockReturn()); // è¾“å‡º: 42
   
   // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå¼‚æ­¥æˆåŠŸçš„å‡½æ•°
   const mockAsyncSuccess = jest.fn().mockResolvedValue({ data: 'success' });
   mockAsyncSuccess().then(data => console.log(data)); // è¾“å‡º: { data: 'success' }
   
   // è®°å½•è°ƒç”¨ä¿¡æ¯
   function testFunction(callback) {
     callback('arg1', 'arg2');
   }
   testFunction(mockCallback);
   expect(mockCallback.mock.calls.length).toBe(1); // è¢«è°ƒç”¨äº†ä¸€æ¬¡
   expect(mockCallback.mock.calls[0][0]).toBe('arg1'); // ç¬¬ä¸€æ¬¡è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ 'arg1'
   expect(mockCallback.mock.calls[0][1]).toBe('arg2'); // ç¬¬ä¸€æ¬¡è°ƒç”¨çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ 'arg2'
```



### Jest ç”Ÿå‘½å‘¨æœŸ

1. å…¨å±€è®¾ç½®	**beforeAll()** æ‰€æœ‰æµ‹è¯•å‰æ‰§è¡Œ
```js
   beforeAll(() => {...})
```
2. æµ‹è¯•é—´è®¾ç½®	**beforeEach()**	æ¯ä¸ªæµ‹è¯•å‰æ‰§è¡Œ	
```js
   beforeEach(() => {...})
```
3. æµ‹è¯•é—´æ¸…ç†		**afterEach()**	æ¯ä¸ªæµ‹è¯•åæ‰§è¡Œ
```js
   afterEach(() => {...})
```
4. å…¨å±€æ¸…ç†	**afterAll()**	æ‰€æœ‰æµ‹è¯•åæ‰§è¡Œ
```js
   afterAll(() => {...})
```
### NestJS ä¸ Jest çš„å…³è”

#### ä»€ä¹ˆæ˜¯ NestJSï¼Ÿ

NestJS æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé«˜æ•ˆã€å¯æ‰©å±•çš„ Node.js æœåŠ¡å™¨ç«¯åº”ç”¨çš„æ¸è¿›å¼æ¡†æ¶ï¼Œè€ŒJestæ˜¯ä¸€ä¸ªJavaScriptæµ‹è¯•æ¡†æ¶ã€‚ å®ƒä»¬ä¹‹é—´çš„å…³è”åœ¨äºï¼šNestJSå®˜æ–¹æ¨èå¹¶å†…ç½®é›†æˆäº†Jestä½œä¸ºå…¶æµ‹è¯•æ¡†æ¶ã€‚

#### æ ¸å¿ƒå…³ç³»è¯´æ˜

NestJS å’Œ Jest å½¢æˆäº†é«˜åº¦é›†æˆçš„æŠ€æœ¯åä½œå…³ç³»ï¼Œè¿™ç§å…³ç³»ä½“ç°åœ¨å¤šä¸ªå±‚é¢ï¼š

| **ç»´åº¦**     | **NestJS çš„è§’è‰²**       | **Jest çš„è§’è‰²**          | **åä½œæ–¹å¼**                                |
|--------------|------------------------|--------------------------|--------------------------------------------|
| **å®˜æ–¹æ”¯æŒ** | æ¡†æ¶æä¾›è€…             | å®˜æ–¹æµ‹è¯•æ–¹æ¡ˆ             | NestJS CLI é»˜è®¤é›†æˆ Jest                   |
| **æµ‹è¯•ç±»å‹** | åº”ç”¨æ¶æ„åŸºç¡€           | æµ‹è¯•æ‰§è¡Œå¼•æ“             | Jest æµ‹è¯• Nest åº”ç”¨å„å±‚çº§                  |
| **å¼€å‘ä½“éªŒ** | æä¾›æµ‹è¯•å·¥å…·           | æä¾›æ–­è¨€å’Œè¿è¡Œç¯å¢ƒ       | æ— ç¼ç»“åˆçš„æµ‹è¯•å¼€å‘æµç¨‹                     |
| **ç”Ÿæ€æ•´åˆ** | æ¨¡å—åŒ–ç³»ç»Ÿ             | æµ‹è¯•æ¡†æ¶                 | Jest æ‰©å±• Nest æ¨¡å—æµ‹è¯•èƒ½åŠ›                 |

#### åˆ†å±‚æµ‹è¯•æ”¯æŒ

Jest å®Œç¾é€‚é… NestJS çš„åˆ†å±‚æ¶æ„ï¼š

| æµ‹è¯•ç±»å‹   | æµ‹è¯•å¯¹è±¡         | Jest åœ¨ Nest ä¸­çš„å®ç°                           |
|------------|------------------|------------------------------------------------|
| **å•å…ƒæµ‹è¯•** | å•ä¸ªç±»/æœåŠ¡       | ä½¿ç”¨ `Test.createTestingModule()`              |
| **é›†æˆæµ‹è¯•** | æ¨¡å—é—´äº¤äº’       | æ¨¡æ‹Ÿä¾èµ–å…³ç³»å¹¶æµ‹è¯•æ¨¡å—é›†æˆ                     |
| **E2E æµ‹è¯•** | å®Œæ•´åº”ç”¨æµ       | é€šè¿‡ `supertest` æµ‹è¯• HTTP ç«¯ç‚¹                |

#### åä½œä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | å•ç‹¬ä½¿ç”¨ Jest | NestJS + Jest é›†æˆ | ä¼˜åŠ¿æå‡ |
|------|---------------|--------------------|----------|
| **ä¾èµ–æ³¨å…¥æµ‹è¯•** | éœ€æ‰‹åŠ¨æ¨¡æ‹Ÿ | å†…ç½® DI å®¹å™¨æ”¯æŒ | æµ‹è¯•å¤æ‚åº¦é™ä½ 70% |
| **æ¨¡å—åŒ–æµ‹è¯•** | å›°éš¾ | TestingModule åŸç”Ÿæ”¯æŒ | æ¨¡å—éš”ç¦»æ€§æå‡ |
| **é…ç½®å¤æ‚åº¦** | ä¸­ç­‰ | CLI è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–é…ç½® | åˆå§‹åŒ–æ—¶é—´å‡å°‘ 90% |
| **ä¸­é—´ä»¶æµ‹è¯•** | å¤æ‚ | ä¸“ç”¨æµ‹è¯•å·¥å…·é“¾ | æµ‹è¯•ä»£ç å‡å°‘ 50% |
| **TypeScript æ”¯æŒ** | éœ€é¢å¤–é…ç½® | å¼€ç®±å³ç”¨å®Œç¾æ”¯æŒ | ç±»å‹å®‰å…¨ä¿è¯ |


## è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·å®ä¾‹

#### 1. æ¥å…¥é¡¹ç›®

1. å®‰è£… Jest
```bash
npm install --save-dev jest@28.1.3
```
2. å®‰è£… NestJS
```bash
npm install -g @nestjs/cli
```
3. æ·»åŠ æµ‹è¯•è„šæœ¬
```json
{
  "scripts": {
    "test": "jest"
  }
}
```
4. é…ç½® Jest
```js
// package.json
"jest": {
    "moduleFileExtensions": ["js", "json", "ts"],
        "testMatch": [
        "**/*.spec.ts",
        "**/*.e2e-spec.ts"
    ],
        "rootDir": ".",
        "transform": {
        "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": ["**/*.(t|j)s"],
        "coverageDirectory": "../coverage",
        "testEnvironment": "node",
        "moduleNameMapper": {
        "^@app/(.*)$": "<rootDir>/application/$1"
    },
    "verbose": true,
        "testPathIgnorePatterns": []
}
```

#### 2. ç¼–å†™æµ‹è¯•è„šæœ¬
 2.1  AIGCå¯¼å‡ºæœåŠ¡æµ‹è¯•

åœ¨`test`ç›®å½•ä¸‹åˆ›å»º`export-aigc.service.spec.ts`æ–‡ä»¶

```js
// å¯¼å…¥æµ‹è¯•æ‰€éœ€çš„NestJSæµ‹è¯•å·¥å…·
import { Test, TestingModule } from '@nestjs/testing';
// å¯¼å…¥è¦æµ‹è¯•çš„AIGCå¯¼å‡ºæœåŠ¡
import { ExportAIGCService } from '@app/export/export-aigc.service';
// å¯¼å…¥AIGCå¯¼å‡ºæœåŠ¡ä¾èµ–çš„æµè§ˆå™¨æœåŠ¡
import { BrowserService } from '@app/browser/browser.service';
// å¯¼å…¥AIGCå¯¼å‡ºæœåŠ¡ä½¿ç”¨çš„æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰
import { ExportAIGCReportDto } from '@app/export/dto/ExportAIGCReport.dto';
```
è®¾ç½®å…¨å±€æµ‹è¯•è¶…æ—¶ä¸º60ç§’`ï¼ˆå› ä¸ºé›†æˆæµ‹è¯•éœ€è¦è®¿é—®çœŸå®ç½‘ç»œèµ„æºï¼‰`

```js
jest.setTimeout(60000);
```

å®šä¹‰æµ‹è¯•å¥—ä»¶ï¼šAIGCå¯¼å‡ºæœåŠ¡æµ‹è¯•
```js
describe('ExportAIGCService', () => {...});
```
å£°æ˜æµ‹è¯•ä¸­ä½¿ç”¨çš„å˜é‡
```js
 // AIGCå¯¼å‡ºæœåŠ¡å®ä¾‹
let service: ExportAIGCService;
// æµè§ˆå™¨æœåŠ¡å®ä¾‹
let browserService: BrowserService;
// NestJSæµ‹è¯•æ¨¡å—å®ä¾‹
let module: TestingModule;
```

ä½¿ç”¨beforeAllåœ¨æ‰€æœ‰æµ‹è¯•å¼€å§‹å‰æ‰§è¡Œï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰

```js
beforeAll(async () => {
    // åˆ›å»ºNestJSæµ‹è¯•æ¨¡å—
    module = await Test.createTestingModule({
        // é…ç½®æµ‹è¯•æ¨¡å—ä¸­éœ€è¦ä½¿ç”¨çš„æœåŠ¡
        providers: [
            // è¦æµ‹è¯•çš„AIGCå¯¼å‡ºæœåŠ¡
            ExportAIGCService,
            // ä½¿ç”¨çœŸå®çš„æµè§ˆå™¨æœåŠ¡
            BrowserService,
        ],
    }).compile();  // ç¼–è¯‘æµ‹è¯•æ¨¡å—ï¼Œå‡†å¤‡ä¾èµ–æ³¨å…¥

    // ä»æµ‹è¯•æ¨¡å—ä¸­è·å–AIGCå¯¼å‡ºæœåŠ¡å®ä¾‹
    service = module.get<ExportAIGCService>(ExportAIGCService);
    // ä»æµ‹è¯•æ¨¡å—ä¸­è·å–æµè§ˆå™¨æœåŠ¡å®ä¾‹
    browserService = module.get<BrowserService>(BrowserService);
    // æ‰‹åŠ¨åˆå§‹åŒ–æµè§ˆå™¨æ± 
    await (browserService as any).initPool();
});
```
ä½¿ç”¨ afterAll åœ¨æ‰€æœ‰æµ‹è¯•ç»“æŸåæ‰§è¡Œï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰

```js
afterAll(async () => {
    // è·å–æµè§ˆå™¨æœåŠ¡ä¸­çš„æµè§ˆå™¨æ± å®ä¾‹
    const pool = (browserService as any).browserPool;

    // å¦‚æœæµè§ˆå™¨æ± å­˜åœ¨ï¼Œè¿›è¡Œæ¸…ç†å·¥ä½œ
    if (pool) {
        // åœæ­¢æ¥å—æ–°ä»»åŠ¡
        await pool.drain();
        // å…³é—­æ‰€æœ‰æµè§ˆå™¨å®ä¾‹
        await pool.clear();
    }

    // å…³é—­æµ‹è¯•æ¨¡å—ï¼Œé‡Šæ”¾æ‰€æœ‰èµ„æº
    await module.close();

    // æ¢å¤æ—¥å¿—è®°å½•å™¨çš„åŸå§‹å®ç°
    jest.restoreAllMocks();
});
```
ç¼–å†™æµ‹è¯•ç”¨ä¾‹1: æˆåŠŸå¯¼å‡ºAIGCæŠ¥å‘Š

```js
it('åº”è¯¥æˆåŠŸå¯¼å‡ºAIGC PDFæŠ¥å‘Š', async () => {
    // åˆ›å»ºæµ‹è¯•æ•°æ®ä¼ è¾“å¯¹è±¡(DTO)
    const dto: ExportAIGCReportDto = {
        taskId: 'ag250702144740050894819842'
    };

    // è°ƒç”¨AIGCå¯¼å‡ºæœåŠ¡çš„æ–¹æ³•
    const [result, error] = await service.exportAIGCReport(dto);
    // æ–­è¨€éªŒè¯
    expect(error).toBeNull();  // æœŸæœ›æ²¡æœ‰é”™è¯¯
    expect(typeof result).toBe('string');  // æœŸæœ›ç»“æœæ˜¯å­—ç¬¦ä¸²
});
```

ç¼–å†™æµ‹è¯•ç”¨ä¾‹2: æµ‹è¯•å¤„ç†æ— æ•ˆå‚æ•°çš„æƒ…å†µ

```js
it('å¤„ç†æ— æ•ˆå‚æ•°', async () => {
    // åˆ›å»ºæµ‹è¯•æ•°æ®ä¼ è¾“å¯¹è±¡(DTO)ï¼ŒåŒ…å«æ— æ•ˆçš„å‚æ•°
    const dto: ExportAIGCReportDto = {
        taskId: ''
    };

    // è°ƒç”¨æœåŠ¡çš„æ–¹æ³•
    const [result, error] = await service.exportAIGCReport(dto);

    // æ–­è¨€1: æœŸæœ›ç»“æœä¸ºç©ºï¼ˆresultåº”ä¸ºnullï¼‰
    expect(result).toBeNull();

    // æ–­è¨€2: æœŸæœ›æœ‰é”™è¯¯ä¿¡æ¯ï¼ˆerrorä¸åº”ä¸ºnullï¼‰
    expect(error).not.toBeNull();
    // å¿«ç…§æµ‹è¯•ï¼šæ•è·é”™è¯¯å¯¹è±¡çš„å®Œæ•´ç»“æ„
    expect(error).toMatchSnapshot();
});
```

#### 3. æ‰§è¡Œæµ‹è¯•

```bash
npm test
```

#### 4. æ‰§è¡Œç»“æœ

æ‰§è¡Œè¿›è¡Œä¸­çŠ¶æ€

```js
//è¾“å…¥æ‰§è¡Œå‘½ä»¤
PS E:\service_node> npm test

> service_node@0.0.1 test
> jest

//æ‰§è¡Œä¼šé»˜è®¤ä¼šæŠŠé…ç½®å¥½åŒ¹é…æ–‡ä»¶åç¼€ååŒ¹é…çš„æ–‡ä»¶è¿‡æ»¤å‡ºæ¥
 RUNS  test/export-drawing.service.spec.ts
 RUNS  test/export-journal-compare.spec.ts
 RUNS  test/export-resume.service.spec.ts
 RUNS  test/export-aigc.service.spec.ts
 RUNS  test/export-journal-report.service.spec.ts
 RUNS  test/app.e2e-spec.ts

// æ‰§è¡Œè¿›åº¦ï¼ˆå½“å‰è¿›è¡Œè¿›è¡Œçš„æ–‡ä»¶/æ€»æ–‡ä»¶ï¼‰
Test Suites: 0 of 6 total

//æµ‹è¯•ç”¨ä¾‹æ•°é‡ï¼ˆå½“å‰å®Œæˆæ•°é‡ï¼‰
Tests:       0 total

//å±å¹•å¿«ç…§ ï¼ˆå½“å‰å®Œæˆæ•°é‡ï¼‰
Snapshots:   0 total

//é¢„è®¡æ—¶é—´ ï¼ˆæ‰§è¡Œæ—¶é—´/é¢„è®¡æ—¶é—´ï¼‰
Time:        3 s, estimated 15 s
```

**æ‰§è¡Œå·²å®Œæˆ**
 - æŠ¥é”™æ–‡ä»¶ä¿¡æ¯
```js
FAIL  test/app.e2e-spec.ts
  â— Test suite failed to run
    Your test suite must contain at least one test.
      at onResult (node_modules/@jest/core/build/TestScheduler.js:172:18)
      at node_modules/@jest/core/build/TestScheduler.js:300:17
      at node_modules/emittery/index.js:311:13
          at Array.map (<anonymous>)
      at Emittery.emit (node_modules/emittery/index.js:309:23)
```
- æˆåŠŸæ–‡ä»¶ä¿¡æ¯

```js
//æµ‹è¯•æ–‡ä»¶åœ°å€ä»¥åŠè¿è¡Œæ¶ˆè€—æ—¶é—´
 PASS  test/export-journal-report.service.spec.ts (6.319 s)
    // æµ‹è¯•å¥—ä»¶åç§°
  ExportJournalReportService
    //æµ‹è¯•ç”¨ä¾‹å®ŒæˆçŠ¶æ€ä¸è€—æ—¶
    âˆš ç”ŸæˆæœŸåˆŠæŠ¥å‘ŠPDF (1736 ms)
    âˆš å¤„ç†æ— æ•ˆå‚æ•° (452 ms)    
```
- æ‰§è¡Œå®ŒæˆçŠ¶æ€

```js
// æµ‹è¯•æ–‡ä»¶å®Œæˆæƒ…å†µ
Test Suites: 1 failed, 5 passed, 6 total
// æµ‹è¯•ç”¨ä¾‹å®Œæˆæƒ…å†µ
Tests:       11 passed, 11 total
//å±å¹•å¿«ç…§ä¿¡æ¯
Snapshots:   1 passed, 1 total
//æµ‹è¯•æ‰€ç”¨æ—¶é—´
Time:        16.126 s
Ran all test suites.
```
##### å±å¹•å¿«ç…§ä¿¡æ¯

åœ¨ Jest æµ‹è¯•æ¡†æ¶ä¸­ï¼ŒSnapshotsï¼ˆå¿«ç…§ï¼‰ æ˜¯ä¸€ç§ç‰¹æ®Šçš„æµ‹è¯•æœºåˆ¶ï¼Œä¸»è¦ç”¨äºéªŒè¯è¾“å‡ºç»“æœæ˜¯å¦ä¸é¢„æœŸä¸€è‡´ã€‚

1. æ ¸å¿ƒä½œç”¨
   - è‡ªåŠ¨ç”Ÿæˆå‚è€ƒæ¨¡æ¿,é¦–æ¬¡è¿è¡Œæµ‹è¯•æ—¶ï¼ŒJest ä¼šæ•è·è¢«æµ‹å¯¹è±¡çš„è¾“å‡ºï¼ˆå¦‚ UI æ¸²æŸ“ç»“æœã€æ•°æ®ç»“æ„ç­‰ï¼‰;
   - è‡ªåŠ¨ç”Ÿæˆ .snap å¹¶ä¸”æ–‡ä»¶ä¿å­˜åœ¨ __snapshots__ ç›®å½•ä¸­ä½œä¸º"é»„é‡‘æ ‡å‡†";
   - åç»­æµ‹è¯•è¿è¡Œæ—¶ï¼ŒJest ä¼šå°†å½“å‰è¾“å‡ºä¸å¿«ç…§æ–‡ä»¶æ¯”å¯¹,ä»»ä½•ä¸ä¸€è‡´éƒ½ä¼šå¯¼è‡´æµ‹è¯•å¤±è´¥ï¼ˆé™¤éæ˜¯é¢„æœŸå˜æ›´ï¼‰;</br>

###### å…·ä½“ä½¿ç”¨æ–¹å¼ï¼š

```js
// æµ‹è¯•ç”¨ä¾‹2: æµ‹è¯•å¤„ç†æ— æ•ˆå‚æ•°çš„æƒ…å†µ
it('å¤„ç†æ— æ•ˆå‚æ•°', async () => {
// åˆ›å»ºæµ‹è¯•æ•°æ®ä¼ è¾“å¯¹è±¡(DTO)ï¼ŒåŒ…å«æ— æ•ˆçš„å‚æ•°
   const dto: ExportAIGCReportDto = {
      taskId: ''
   };
   // è°ƒç”¨æœåŠ¡çš„æ–¹æ³•
   const [result, error] = await service.exportAIGCReport(dto);
   // å¿«ç…§æµ‹è¯•ï¼šæ•è·é”™è¯¯å¯¹è±¡çš„å®Œæ•´ç»“æ„
    expect(error).toMatchSnapshot();
});
```
è¿è¡Œæµ‹è¯•ç»“æŸåç”Ÿæ–‡ä»¶ç”Ÿæˆä½ç½®æ˜¯ä¸æµ‹è¯•æ–‡ä»¶åŒçº§åˆ›å»ºä¸€ä¸ª __snapshots__ æ–‡ä»¶å¤¹ä¸‹é¢åˆ›å»ºä¸æµ‹è¯•æ–‡ä»¶åŒåï¼Œåç¼€åä¸º.snap çš„æ–‡ä»¶ï¼š

<img src="http://chat.xishanyigu.com/img_1.png">







å¦‚æœåç»­éœ€æ±‚å˜æ›´äº†æœªä¼ id **æŠ¥é”™msgå‘ç”Ÿäº†å˜æ›´**ï¼Œç„¶åè¿›è¡Œæµ‹è¯•é‚£ä¹ˆå±å¹•å¿«ç…§ä¿¡æ¯å°±ä¼šæ˜¾ç¤ºæŠ¥é”™ï¼š


```js
Snapshot Summary

//è¿™é‡Œæœ‰æ˜¾ç¤ºæŠ¥é”™ä¿¡æ¯ï¼Œä»–ä¹Ÿä¼šæé†’ä½ æ‰§è¡Œå‘½ä»¤æ¥æ›´æ–°å±å¹•å¿«ç…§ä¿¡æ¯
 â€º 1 snapshot failed from 1 test suite. Inspect your code changes or run `npm test -- -u` to update them.
Test Suites: 2 failed, 4 passed, 6 total
Tests:       1 failed, 10 passed, 11 total
//è¿™é‡Œæ˜¾ç¤ºå¿«ç…§ä¸€å…±ä¸€é¡¹æœªé€šè¿‡ä¸€é¡¹
Snapshots:   1 failed, 1 total
Time:        16.425 s
Ran all test suites.
```
é‡åˆ°è¿™ç§ä¿¡æ¯å˜æ›´æˆ‘ä»¬éœ€è¦æ‰§è¡Œå‘½ä»¤ `jest --updateSnapshot` æ›´æ–°å±å¹•å¿«ç…§ä¿¡æ¯,æ›´æ–°åè¿è¡Œç»“æœ

```js
// å¿«ç…§æ‘˜è¦
Snapshot Summary
 â€º 1 snapshot updated from 1 test suite.

Test Suites: 1 failed, 5 passed, 6 total
Tests:       11 passed, 11 total
// å¿«ç…§ä¿¡æ¯ä¼šæ˜¾ç¤ºæ›´æ–°ä¿¡æ¯
Snapshots:   1 updated, 1 total
Time:        16.165 s
Ran all test suites.
```
å±å¹•å¿«ç…§çš„é€‚ç”¨åœºæ™¯ï¼š
   - è¾“å‡ºç»“æ„ç¨³å®šä½†å†…å®¹å¤æ‚ï¼ˆå¦‚å¤§æ®µ HTML/XMLï¼‰
   - éœ€è¦é˜²æ­¢æ„å¤–å˜æ›´çš„é…ç½®å¯¹è±¡
   - è·¨å›¢é˜Ÿå…±äº«çš„æ¥å£è§„èŒƒ

å±å¹•å¿«ç…§çš„ä¸é€‚ç”¨åœºæ™¯ï¼š
   - åŒ…å«åŠ¨æ€æ•°æ®ï¼ˆæ—¶é—´æˆ³ã€éšæœº IDï¼‰
   - é¢‘ç¹å˜æ›´çš„è¾“å‡º
   - ç®€å•çš„æ•°å€¼/å¸ƒå°”å€¼æ–­è¨€

ç›®å‰æˆ‘çš„nodejsæœåŠ¡é‡Œé¢çš„å¯¼å‡ºè¿”å›ç»“æœä¿¡æ¯å·®ä¸å¤šéƒ½æ˜¯æ–‡ä»¶ä¿¡æ¯ï¼Œbase64ç¼–ç çš„PDFå†…å®¹éå¸¸é•¿ï¼Œç„¶åå°±æ˜¯å³ä½¿PDFå†…å®¹æœ‰å¾®å°å˜åŒ–ï¼ˆæ¯”å¦‚æ—¶é—´æˆ³ã€éšæœºIDç­‰ï¼‰ï¼Œæ•´ä¸ªbase64å­—ç¬¦ä¸²å°±ä¼šå®Œå…¨ä¸åŒï¼Œå¯¼è‡´å¿«ç…§å¤±è´¥ã€‚

å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å°†æ­£ç¡®è¿”å›çš„pdf,ba64æ–‡ä»¶ä¿¡æ¯è¿›è¡Œå¿«ç…§ä¿å­˜ï¼ŒåŒä¸€ä¸ªidï¼Œå¯¼å‡ºæµ‹è¯•ä¸¤æ¬¡çš„ba64ä¿¡æ¯ä¹Ÿä¸ç›¸åŒæ‰€ä»¥æ­¤å¤„ä½¿ç”¨å¿«ç…§å¹¶ä¸åˆé€‚ï¼š

<img src="http://chat.xishanyigu.com/img_2.png">